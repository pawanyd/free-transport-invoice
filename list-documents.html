<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List Documents - Transport Invoice Management System</title>
    <link rel="stylesheet" href="./assets/css/styles.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .animate-fade-out {
            animation: fadeOut 0.3s ease-out;
        }
        
        #recordsTable table {
            table-layout: auto;
            width: 100%;
        }
        
        #recordsTable td, #recordsTable th {
            white-space: nowrap;
        }
        
        #recordsTable td:nth-child(4) {
            white-space: normal;
            max-width: 200px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <%- include('components/layout/header', { activePage: 'list' }) %>

        <main class="bg-white shadow-md rounded-lg p-6">
            <%- include('components/ui/search-bar', { 
                title: 'All Freight Records',
                placeholder: 'Search by origin, destination...'
            }) %>

            <%- include('components/ui/loading-indicator', { message: 'Loading records...' }) %>

            <%- include('components/ui/empty-state', { 
                title: 'No Records Found',
                message: 'You haven\'t created any freight records yet.',
                actionUrl: './index.html',
                actionText: 'Create New Record'
            }) %>

            <div id="recordsTable" class="hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Origin</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destination</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Goods</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Weight (kg)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (â‚¹)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>

                <%- include('components/ui/pagination') %>
            </div>
        </main>
    </div>

    <%- include('components/ui/modal') %>

    <script src="./assets/lib/sql-wasm.js"></script>
    <script src="./assets/lib/html2canvas.min.js"></script>
    <script src="./assets/lib/jspdf.umd.min.js"></script>
    
    <script type="module">
      import { APP_VERSION } from './assets/js/version.js';
      
      const AuthManager = (await import(`./assets/js/auth.js?v=${APP_VERSION}`)).default;
      const DataStoreManager = (await import(`./assets/js/datastore.js?v=${APP_VERSION}`)).default;
      const { DocumentGenerator } = await import(`./assets/js/generator.js?v=${APP_VERSION}`);
      const { PDFExporter } = await import(`./assets/js/pdf-exporter.js?v=${APP_VERSION}`);

      class ListController {
        constructor() {
          this.authManager = new AuthManager();
          this.dataStore = new DataStoreManager();
          this.documentGenerator = new DocumentGenerator();
          this.pdfExporter = new PDFExporter();
          this.allRecords = [];
          this.filteredRecords = [];
          this.currentPage = 1;
          this.recordsPerPage = 15;
        }

        async init() {
          await this.authManager.initialize();
          if (!this.authManager.isAuthenticated()) {
            window.location.href = './login.html';
            return;
          }

          const initResult = await this.dataStore.initialize();
          if (!initResult.success) {
            this.showError('Failed to initialize database');
            return;
          }

          this.setupEventListeners();
          await this.loadRecords();
        }

        setupEventListeners() {
          document.getElementById('logoutBtn')?.addEventListener('click', () => this.handleLogout());
          document.getElementById('refreshBtn')?.addEventListener('click', () => this.loadRecords());
          document.getElementById('searchInput')?.addEventListener('input', (e) => this.handleSearch(e.target.value));
          document.getElementById('closeModal')?.addEventListener('click', () => this.closeModal());
          
          document.getElementById('firstPageBtn')?.addEventListener('click', () => this.goToPage(1));
          document.getElementById('prevPageBtn')?.addEventListener('click', () => this.goToPage(this.currentPage - 1));
          document.getElementById('nextPageBtn')?.addEventListener('click', () => this.goToPage(this.currentPage + 1));
          document.getElementById('lastPageBtn')?.addEventListener('click', () => this.goToPage(this.getTotalPages()));
        }

        async loadRecords() {
          const loadingIndicator = document.getElementById('loadingIndicator');
          const emptyState = document.getElementById('emptyState');
          const recordsTable = document.getElementById('recordsTable');

          loadingIndicator?.classList.remove('hidden');
          emptyState?.classList.add('hidden');
          recordsTable?.classList.add('hidden');

          try {
            const userId = this.authManager.getUserId();
            this.allRecords = this.dataStore.getUserFreightRecords(userId);
            this.filteredRecords = [...this.allRecords];
            this.currentPage = 1;

            loadingIndicator?.classList.add('hidden');

            if (this.allRecords.length === 0) {
              emptyState?.classList.remove('hidden');
            } else {
              recordsTable?.classList.remove('hidden');
              this.renderRecords();
              this.updatePaginationControls();
            }
          } catch (error) {
            console.error('Failed to load records:', error);
            loadingIndicator?.classList.add('hidden');
            this.showError('Failed to load records');
          }
        }

        getTotalPages() {
          return Math.ceil(this.filteredRecords.length / this.recordsPerPage);
        }

        getPaginatedRecords() {
          const startIndex = (this.currentPage - 1) * this.recordsPerPage;
          const endIndex = startIndex + this.recordsPerPage;
          return this.filteredRecords.slice(startIndex, endIndex);
        }

        goToPage(pageNumber) {
          const totalPages = this.getTotalPages();
          if (pageNumber < 1 || pageNumber > totalPages) return;
          
          this.currentPage = pageNumber;
          this.renderRecords();
          this.updatePaginationControls();
        }

        updatePaginationControls() {
          const totalPages = this.getTotalPages();
          const startRecord = (this.currentPage - 1) * this.recordsPerPage + 1;
          const endRecord = Math.min(this.currentPage * this.recordsPerPage, this.filteredRecords.length);

          document.getElementById('currentPage').textContent = this.currentPage;
          document.getElementById('totalPages').textContent = totalPages;
          document.getElementById('recordsFrom').textContent = this.filteredRecords.length > 0 ? startRecord : 0;
          document.getElementById('recordsTo').textContent = endRecord;
          document.getElementById('recordsTotal').textContent = this.filteredRecords.length;

          const firstPageBtn = document.getElementById('firstPageBtn');
          const prevPageBtn = document.getElementById('prevPageBtn');
          const nextPageBtn = document.getElementById('nextPageBtn');
          const lastPageBtn = document.getElementById('lastPageBtn');

          if (firstPageBtn) firstPageBtn.disabled = this.currentPage === 1;
          if (prevPageBtn) prevPageBtn.disabled = this.currentPage === 1;
          if (nextPageBtn) nextPageBtn.disabled = this.currentPage === totalPages || totalPages === 0;
          if (lastPageBtn) lastPageBtn.disabled = this.currentPage === totalPages || totalPages === 0;
        }

        renderRecords() {
          const tbody = document.getElementById('recordsTableBody');
          if (!tbody) return;

          tbody.innerHTML = '';

          const paginatedRecords = this.getPaginatedRecords();

          paginatedRecords.forEach(record => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            const date = new Date(record.createdAt).toLocaleDateString('en-IN', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            });

            row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${record.id}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${this.escapeHtml(record.origin)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${this.escapeHtml(record.destination)}</td>
              <td class="px-6 py-4 text-sm text-gray-700 max-w-xs truncate" title="${this.escapeHtml(record.goodsDescription)}">${this.escapeHtml(record.goodsDescription)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${record.weight}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">â‚¹${record.amount.toFixed(2)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex gap-2">
                  <button class="text-blue-600 hover:text-blue-900" onclick="window.listController.viewBilty(${record.id})">
                    Bilty
                  </button>
                  <button class="text-purple-600 hover:text-purple-900" onclick="window.listController.viewInvoice(${record.id})">
                    Invoice
                  </button>
                  <button class="text-green-600 hover:text-green-900" onclick="window.listController.downloadBilty(${record.id})">
                    ðŸ“„
                  </button>
                  <button class="text-green-600 hover:text-green-900" onclick="window.listController.downloadInvoice(${record.id})">
                    ðŸ“‹
                  </button>
                </div>
              </td>
            `;

            tbody.appendChild(row);
          });
        }

        handleSearch(query) {
          const searchTerm = query.toLowerCase().trim();
          
          if (!searchTerm) {
            this.filteredRecords = [...this.allRecords];
          } else {
            this.filteredRecords = this.allRecords.filter(record => 
              record.origin.toLowerCase().includes(searchTerm) ||
              record.destination.toLowerCase().includes(searchTerm) ||
              record.goodsDescription.toLowerCase().includes(searchTerm) ||
              record.id.toString().includes(searchTerm)
            );
          }

          this.currentPage = 1;
          this.renderRecords();
          this.updatePaginationControls();

          const emptyState = document.getElementById('emptyState');
          const recordsTable = document.getElementById('recordsTable');
          
          if (this.filteredRecords.length === 0) {
            recordsTable?.classList.add('hidden');
            emptyState?.classList.remove('hidden');
            emptyState.querySelector('h3').textContent = 'No Matching Records';
            emptyState.querySelector('p').textContent = 'Try adjusting your search criteria.';
          } else {
            emptyState?.classList.add('hidden');
            recordsTable?.classList.remove('hidden');
          }
        }

        viewBilty(recordId) {
          const record = this.allRecords.find(r => r.id === recordId);
          if (!record) return;

          const bilty = this.documentGenerator.generateBilty(record);
          if (bilty) {
            this.showModal(bilty, 'Bilty', recordId);
          }
        }

        viewInvoice(recordId) {
          const record = this.allRecords.find(r => r.id === recordId);
          if (!record) return;

          const invoice = this.documentGenerator.generateInvoice(record);
          if (invoice) {
            this.showModal(invoice, 'Invoice', recordId);
          }
        }

        async downloadBilty(recordId) {
          const record = this.allRecords.find(r => r.id === recordId);
          if (!record) return;

          const loadingDiv = this.showLoadingOverlay('Generating Bilty PDF...');

          try {
            const bilty = this.documentGenerator.generateBilty(record);
            if (bilty) {
              const filename = this.pdfExporter.generateFilename('bilty', recordId);
              await this.pdfExporter.exportToPDF(bilty, filename);
              this.showSuccessToast('Bilty PDF downloaded successfully!');
            } else {
              throw new Error('Failed to generate bilty document');
            }
          } catch (error) {
            console.error('Failed to download bilty:', error);
            this.showErrorToast('Failed to download bilty PDF: ' + error.message);
          } finally {
            this.hideLoadingOverlay(loadingDiv);
          }
        }

        async downloadInvoice(recordId) {
          const record = this.allRecords.find(r => r.id === recordId);
          if (!record) return;

          const loadingDiv = this.showLoadingOverlay('Generating Invoice PDF...');

          try {
            const invoice = this.documentGenerator.generateInvoice(record);
            if (invoice) {
              const filename = this.pdfExporter.generateFilename('invoice', recordId);
              await this.pdfExporter.exportToPDF(invoice, filename);
              this.showSuccessToast('Invoice PDF downloaded successfully!');
            } else {
              throw new Error('Failed to generate invoice document');
            }
          } catch (error) {
            console.error('Failed to download invoice:', error);
            this.showErrorToast('Failed to download invoice PDF: ' + error.message);
          } finally {
            this.hideLoadingOverlay(loadingDiv);
          }
        }

        showModal(documentElement, title, recordId) {
          const modal = document.getElementById('previewModal');
          const modalContent = document.getElementById('modalContent');
          
          if (!modal || !modalContent) return;

          modalContent.innerHTML = `
            <div class="mb-4 flex justify-between items-center">
              <h4 class="text-lg font-semibold">${title} #${recordId}</h4>
              <button id="downloadFromModal" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                Download PDF
              </button>
            </div>
            <div class="border border-gray-300 rounded p-4">
              ${documentElement.outerHTML}
            </div>
          `;

          document.getElementById('downloadFromModal')?.addEventListener('click', async () => {
            const type = title.toLowerCase();
            const record = this.allRecords.find(r => r.id === recordId);
            if (record) {
              if (type === 'bilty') {
                await this.downloadBilty(recordId);
              } else {
                await this.downloadInvoice(recordId);
              }
            }
          });

          modal.classList.remove('hidden');
        }

        closeModal() {
          const modal = document.getElementById('previewModal');
          modal?.classList.add('hidden');
        }

        handleLogout() {
          this.authManager.logout();
          window.location.href = './login.html';
        }

        showLoadingOverlay(message = 'Loading...') {
          const overlay = document.createElement('div');
          overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          overlay.id = 'loadingOverlay';
          overlay.innerHTML = `
            <div class="bg-white rounded-lg p-6 flex flex-col items-center">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
              <p class="text-gray-700 font-semibold">${message}</p>
            </div>
          `;
          document.body.appendChild(overlay);
          return overlay;
        }

        hideLoadingOverlay(overlay) {
          if (overlay && overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
        }

        showSuccessToast(message) {
          this.showToast(message, 'success');
        }

        showErrorToast(message) {
          this.showToast(message, 'error');
        }

        showToast(message, type = 'info') {
          const toast = document.createElement('div');
          const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
          toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
          toast.textContent = message;
          document.body.appendChild(toast);

          setTimeout(() => {
            toast.classList.add('animate-fade-out');
            setTimeout(() => {
              if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
              }
            }, 300);
          }, 3000);
        }

        showError(message) {
          this.showErrorToast(message);
          console.log(message);
        }

        escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
      }

      const listController = new ListController();
      window.listController = listController;
      listController.init();
    </script>
</body>
</html>

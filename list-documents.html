<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List Bilty / Invoices - Transport Invoice Management System</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .animate-fade-out {
            animation: fadeOut 0.3s ease-out;
        }
        
        /* Ensure table layout is fixed and columns have proper spacing */
        #recordsTable table {
            table-layout: auto;
            width: 100%;
        }
        
        #recordsTable td, #recordsTable th {
            white-space: nowrap;
        }
        
        /* Allow goods description to wrap */
        #recordsTable td:nth-child(4) {
            white-space: normal;
            max-width: 200px;
        }

        /* Print styles */
        @media print {
            body {
                background: white;
            }
            header, .no-print {
                display: none !important;
            }
            #recordsTable {
                display: block !important;
            }
            #recordsTable table {
                page-break-inside: auto;
            }
            #recordsTable tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            #recordsTable td:last-child {
                display: none; /* Hide actions column in print */
            }
            #recordsTable th:last-child {
                display: none; /* Hide actions header in print */
            }
            #paginationControls {
                display: none !important;
            }
        }

        /* Sort indicator styles */
        .sort-icon {
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        th:hover .sort-icon {
            opacity: 0.6;
        }
        th.sort-asc .sort-icon,
        th.sort-desc .sort-icon {
            opacity: 1;
        }
        th.sort-desc .sort-icon {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Header with Navigation -->
        <header class="bg-white shadow-md rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold text-gray-800">Transport Invoice Management System</h1>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                    Logout
                </button>
            </div>
            
            <!-- Navigation Menu -->
            <nav class="border-t pt-4">
                <ul class="flex gap-4">
                    <li>
                        <a href="index.html" class="text-gray-600 hover:text-blue-600 font-medium">
                            Create New
                        </a>
                    </li>
                    <li>
                        <a href="list-documents.html" class="text-blue-600 font-bold border-b-2 border-blue-600">
                            List Bilty / Invoices
                        </a>
                    </li>
                    <li>
                        <a href="dashboard.html" class="text-gray-600 hover:text-blue-600 font-medium">
                            Dashboard
                        </a>
                    </li>
                </ul>
            </nav>
        </header>

        <main class="bg-white shadow-md rounded-lg p-6">
            <!-- Toolbar with Search and Actions -->
            <div class="mb-6 no-print">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                    <h2 class="text-xl font-semibold">All Freight Records</h2>
                    <div class="flex flex-wrap gap-2">
                        <button id="toggleFiltersBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                            </svg>
                            Filters
                        </button>
                        <button id="exportCSVBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Export CSV
                        </button>
                        <button id="printBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                            </svg>
                            Print
                        </button>
                        <button id="refreshBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="mb-4">
                    <input type="text" id="searchInput" placeholder="Search by ID, origin, destination, or goods..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Advanced Filters Panel -->
                <div id="filtersPanel" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <h3 class="text-lg font-semibold mb-4">Advanced Filters</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Date Range Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                            <input type="date" id="filterDateFrom" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                            <input type="date" id="filterDateTo" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Amount Range Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Min Amount (‚Çπ)</label>
                            <input type="number" id="filterAmountMin" placeholder="0" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Max Amount (‚Çπ)</label>
                            <input type="number" id="filterAmountMax" placeholder="999999" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Weight Range Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Min Weight (kg)</label>
                            <input type="number" id="filterWeightMin" placeholder="0" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Max Weight (kg)</label>
                            <input type="number" id="filterWeightMax" placeholder="999999" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Origin Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Origin</label>
                            <input type="text" id="filterOrigin" placeholder="Any origin" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Destination Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Destination</label>
                            <input type="text" id="filterDestination" placeholder="Any destination" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <button id="applyFiltersBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                            Apply Filters
                        </button>
                        <button id="clearFiltersBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">
                            Clear Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading indicator -->
            <div id="loadingIndicator" class="text-center py-8 hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading records...</p>
            </div>

            <!-- Empty state -->
            <div id="emptyState" class="text-center py-12 hidden">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">No Records Found</h3>
                <p class="text-gray-500 mb-4">You haven't created any freight records yet.</p>
                <a href="index.html" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded inline-block">
                    Create New Record
                </a>
            </div>

            <!-- Records table -->
            <div id="recordsTable" class="hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="id">
                                    <div class="flex items-center gap-1">
                                        ID
                                        <svg class="w-4 h-4 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="origin">
                                    <div class="flex items-center gap-1">
                                        Origin
                                        <svg class="w-4 h-4 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="destination">
                                    <div class="flex items-center gap-1">
                                        Destination
                                        <svg class="w-4 h-4 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Goods</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="weight">
                                    <div class="flex items-center gap-1">
                                        Weight (kg)
                                        <svg class="w-4 h-4 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="amount">
                                    <div class="flex items-center gap-1">
                                        Amount (‚Çπ)
                                        <svg class="w-4 h-4 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="createdAt">
                                    <div class="flex items-center gap-1">
                                        Date
                                        <svg class="w-4 h-4 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Records will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div id="paginationControls" class="mt-6 flex items-center justify-between border-t border-gray-200 pt-4">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-700">
                            Showing <span id="recordsFrom" class="font-semibold">0</span> to 
                            <span id="recordsTo" class="font-semibold">0</span> of 
                            <span id="recordsTotal" class="font-semibold">0</span> records
                        </span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="firstPageBtn" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <button id="prevPageBtn" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <span class="text-sm text-gray-700">
                            Page <span id="currentPage" class="font-semibold">1</span> of 
                            <span id="totalPages" class="font-semibold">1</span>
                        </span>
                        <button id="nextPageBtn" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                        <button id="lastPageBtn" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Document Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex justify-between items-center">
                <h3 class="text-lg font-semibold">Document Preview</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="modalContent" class="p-6">
                <!-- Document content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex justify-between items-center">
                <h3 class="text-lg font-semibold">Edit Freight Record</h3>
                <button id="closeEditModal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <form id="editForm" class="space-y-4">
                    <input type="hidden" id="editRecordId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editOrigin" class="block text-sm font-medium text-gray-700 mb-1">Origin *</label>
                            <input type="text" id="editOrigin" name="origin" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="editDestination" class="block text-sm font-medium text-gray-700 mb-1">Destination *</label>
                            <input type="text" id="editDestination" name="destination" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div>
                        <label for="editGoodsDescription" class="block text-sm font-medium text-gray-700 mb-1">Goods Description *</label>
                        <textarea id="editGoodsDescription" name="goodsDescription" required rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editWeight" class="block text-sm font-medium text-gray-700 mb-1">Weight (kg) *</label>
                            <input type="number" id="editWeight" name="weight" required step="0.01" min="0.01"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="editAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount (‚Çπ) *</label>
                            <input type="number" id="editAmount" name="amount" required step="0.01" min="0.01"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editDiscount" class="block text-sm font-medium text-gray-700 mb-1">Discount (‚Çπ)</label>
                            <input type="number" id="editDiscount" name="discount" step="0.01" min="0" value="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="editTaxes" class="block text-sm font-medium text-gray-700 mb-1">Taxes (‚Çπ)</label>
                            <input type="number" id="editTaxes" name="taxes" step="0.01" min="0" value="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editEwayBillNumber" class="block text-sm font-medium text-gray-700 mb-1">eWay Bill Number</label>
                            <input type="text" id="editEwayBillNumber" name="ewayBillNumber"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="editEwayBillDate" class="block text-sm font-medium text-gray-700 mb-1">eWay Bill Date</label>
                            <input type="date" id="editEwayBillDate" name="ewayBillDate"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div id="editErrorMessages" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded"></div>

                    <div class="flex gap-4 pt-4 border-t">
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded">
                            Save Changes
                        </button>
                        <button type="button" id="cancelEdit" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0 w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-4">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Delete Freight Record</h3>
                        <p class="text-sm text-gray-500 mt-1">Record ID: #<span id="deleteRecordId"></span></p>
                    </div>
                </div>
                
                <p class="text-gray-700 mb-6">
                    Are you sure you want to delete this freight record? This action cannot be undone and will also delete all associated document history.
                </p>

                <div class="flex flex-col sm:flex-row gap-3" style="display: flex; flex-direction: column; gap: 12px;">
                    <button id="confirmDelete" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-medium" style="display: block; width: 100%; background-color: #dc2626; color: white; padding: 8px 16px; border-radius: 4px;">
                        Delete
                    </button>
                    <button id="cancelDelete" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded font-medium" style="display: block; width: 100%; background-color: #d1d5db; color: #1f2937; padding: 8px 16px; border-radius: 4px;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="assets/lib/sql-wasm.js"></script>
    <script src="assets/lib/html2canvas.min.js"></script>
    <script src="assets/lib/jspdf.umd.min.js"></script>
    
    <script type="module">
      import { APP_VERSION } from './assets/js/version.js';
      
      // Dynamic imports with version for cache busting
      const AuthManager = (await import(`./assets/js/auth.js?v=${APP_VERSION}`)).default;
      const DataStoreManager = (await import(`./assets/js/datastore.js?v=${APP_VERSION}`)).default;
      const { DocumentGenerator } = await import(`./assets/js/generator.js?v=${APP_VERSION}`);
      const { PDFExporter } = await import(`./assets/js/pdf-exporter.js?v=${APP_VERSION}`);

      class ListController {
        constructor() {
          this.authManager = new AuthManager();
          this.dataStore = new DataStoreManager();
          this.documentGenerator = new DocumentGenerator();
          this.pdfExporter = new PDFExporter();
          this.allRecords = [];
          this.filteredRecords = [];
          this.currentPage = 1;
          this.recordsPerPage = 15;
          this.recordToDelete = null;
          this.sortColumn = 'id';
          this.sortDirection = 'desc';
          this.filters = {
            dateFrom: null,
            dateTo: null,
            amountMin: null,
            amountMax: null,
            weightMin: null,
            weightMax: null,
            origin: '',
            destination: ''
          };
        }

        async init() {
          // Check authentication
          await this.authManager.initialize();
          if (!this.authManager.isAuthenticated()) {
            window.location.href = 'login.html';
            return;
          }

          // Initialize data store
          const initResult = await this.dataStore.initialize();
          if (!initResult.success) {
            this.showError('Failed to initialize database');
            return;
          }

          // Set up event listeners
          this.setupEventListeners();

          // Load records
          await this.loadRecords();
        }

        setupEventListeners() {
          document.getElementById('logoutBtn')?.addEventListener('click', () => this.handleLogout());
          document.getElementById('refreshBtn')?.addEventListener('click', () => this.loadRecords());
          document.getElementById('searchInput')?.addEventListener('input', (e) => this.handleSearch(e.target.value));
          document.getElementById('closeModal')?.addEventListener('click', () => this.closeModal());
          
          // Edit modal listeners
          document.getElementById('closeEditModal')?.addEventListener('click', () => this.closeEditModal());
          document.getElementById('cancelEdit')?.addEventListener('click', () => this.closeEditModal());
          document.getElementById('editForm')?.addEventListener('submit', (e) => this.handleEditSubmit(e));
          
          // Delete modal listeners
          document.getElementById('cancelDelete')?.addEventListener('click', () => this.closeDeleteModal());
          document.getElementById('confirmDelete')?.addEventListener('click', () => this.handleDeleteConfirm());
          
          // Pagination event listeners
          document.getElementById('firstPageBtn')?.addEventListener('click', () => this.goToPage(1));
          document.getElementById('prevPageBtn')?.addEventListener('click', () => this.goToPage(this.currentPage - 1));
          document.getElementById('nextPageBtn')?.addEventListener('click', () => this.goToPage(this.currentPage + 1));
          document.getElementById('lastPageBtn')?.addEventListener('click', () => this.goToPage(this.getTotalPages()));

          // Filter panel listeners
          document.getElementById('toggleFiltersBtn')?.addEventListener('click', () => this.toggleFilters());
          document.getElementById('applyFiltersBtn')?.addEventListener('click', () => this.applyFilters());
          document.getElementById('clearFiltersBtn')?.addEventListener('click', () => this.clearFilters());

          // Export listeners
          document.getElementById('exportCSVBtn')?.addEventListener('click', () => this.exportToCSV());
          document.getElementById('printBtn')?.addEventListener('click', () => this.printList());

          // Sort listeners
          document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => this.handleSort(th.dataset.sort));
          });
        }

        async loadRecords() {
          const loadingIndicator = document.getElementById('loadingIndicator');
          const emptyState = document.getElementById('emptyState');
          const recordsTable = document.getElementById('recordsTable');

          // Show loading
          loadingIndicator?.classList.remove('hidden');
          emptyState?.classList.add('hidden');
          recordsTable?.classList.add('hidden');

          try {
            const userId = this.authManager.getUserId();
            this.allRecords = this.dataStore.getUserFreightRecords(userId);
            this.filteredRecords = [...this.allRecords];
            this.currentPage = 1;

            // Apply current filters and sorting
            this.applyAllFilters();
            this.sortRecords();

            loadingIndicator?.classList.add('hidden');

            if (this.allRecords.length === 0) {
              emptyState?.classList.remove('hidden');
            } else {
              recordsTable?.classList.remove('hidden');
              this.renderRecords();
              this.updatePaginationControls();
              this.updateSortIndicators();
            }
          } catch (error) {
            console.error('Failed to load records:', error);
            loadingIndicator?.classList.add('hidden');
            this.showError('Failed to load records');
          }
        }

        getTotalPages() {
          return Math.ceil(this.filteredRecords.length / this.recordsPerPage);
        }

        getPaginatedRecords() {
          const startIndex = (this.currentPage - 1) * this.recordsPerPage;
          const endIndex = startIndex + this.recordsPerPage;
          return this.filteredRecords.slice(startIndex, endIndex);
        }

        goToPage(pageNumber) {
          const totalPages = this.getTotalPages();
          if (pageNumber < 1 || pageNumber > totalPages) return;
          
          this.currentPage = pageNumber;
          this.renderRecords();
          this.updatePaginationControls();
        }

        updatePaginationControls() {
          const totalPages = this.getTotalPages();
          const startRecord = (this.currentPage - 1) * this.recordsPerPage + 1;
          const endRecord = Math.min(this.currentPage * this.recordsPerPage, this.filteredRecords.length);

          // Update text
          document.getElementById('currentPage').textContent = this.currentPage;
          document.getElementById('totalPages').textContent = totalPages;
          document.getElementById('recordsFrom').textContent = this.filteredRecords.length > 0 ? startRecord : 0;
          document.getElementById('recordsTo').textContent = endRecord;
          document.getElementById('recordsTotal').textContent = this.filteredRecords.length;

          // Update button states
          const firstPageBtn = document.getElementById('firstPageBtn');
          const prevPageBtn = document.getElementById('prevPageBtn');
          const nextPageBtn = document.getElementById('nextPageBtn');
          const lastPageBtn = document.getElementById('lastPageBtn');

          if (firstPageBtn) firstPageBtn.disabled = this.currentPage === 1;
          if (prevPageBtn) prevPageBtn.disabled = this.currentPage === 1;
          if (nextPageBtn) nextPageBtn.disabled = this.currentPage === totalPages || totalPages === 0;
          if (lastPageBtn) lastPageBtn.disabled = this.currentPage === totalPages || totalPages === 0;
        }

        renderRecords() {
          const tbody = document.getElementById('recordsTableBody');
          if (!tbody) return;

          tbody.innerHTML = '';

          const paginatedRecords = this.getPaginatedRecords();

          paginatedRecords.forEach(record => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            const date = new Date(record.createdAt).toLocaleDateString('en-IN', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            });

            row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${record.id}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${this.escapeHtml(record.origin)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${this.escapeHtml(record.destination)}</td>
              <td class="px-6 py-4 text-sm text-gray-700 max-w-xs truncate" title="${this.escapeHtml(record.goodsDescription)}">${this.escapeHtml(record.goodsDescription)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${record.weight}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">‚Çπ${record.amount.toFixed(2)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex gap-2 flex-wrap">
                  <button class="text-blue-600 hover:text-blue-900" onclick="window.listController.viewBilty(${record.id})" title="View Bilty">
                    Bilty
                  </button>
                  <button class="text-purple-600 hover:text-purple-900" onclick="window.listController.viewInvoice(${record.id})" title="View Invoice">
                    Invoice
                  </button>
                  <button class="text-green-600 hover:text-green-900" onclick="window.listController.downloadBilty(${record.id})" title="Download Bilty PDF">
                    üìÑ
                  </button>
                  <button class="text-green-600 hover:text-green-900" onclick="window.listController.downloadInvoice(${record.id})" title="Download Invoice PDF">
                    üìã
                  </button>
                  <button class="text-orange-600 hover:text-orange-900" onclick="window.listController.editRecord(${record.id})" title="Edit Record">
                    ‚úèÔ∏è
                  </button>
                  <button class="text-red-600 hover:text-red-900" onclick="window.listController.deleteRecord(${record.id})" title="Delete Record">
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            `;

            tbody.appendChild(row);
          });
        }

        handleSearch(query) {
          this.applyAllFilters();
          this.currentPage = 1;
          this.sortRecords();
          this.renderRecords();
          this.updatePaginationControls();

          // Show/hide empty state
          const emptyState = document.getElementById('emptyState');
          const recordsTable = document.getElementById('recordsTable');
          
          if (this.filteredRecords.length === 0) {
            recordsTable?.classList.add('hidden');
            emptyState?.classList.remove('hidden');
            emptyState.querySelector('h3').textContent = 'No Matching Records';
            emptyState.querySelector('p').textContent = 'Try adjusting your search criteria.';
          } else {
            emptyState?.classList.add('hidden');
            recordsTable?.classList.remove('hidden');
          }
        }

        viewBilty(recordId) {
          const record = this.allRecords.find(r => r.id === recordId);
          if (!record) return;

          const bilty = this.documentGenerator.generateBilty(record);
          if (bilty) {
            this.showModal(bilty, 'Bilty', recordId);
          }
        }

        viewInvoice(recordId) {
          const record = this.allRecords.find(r => r.id === recordId);
          if (!record) return;

          const invoice = this.documentGenerator.generateInvoice(record);
          if (invoice) {
            this.showModal(invoice, 'Invoice', recordId);
          }
        }

        async downloadBilty(recordId) {
          const record = this.allRecords.find(r => r.id === recordId);
          if (!record) return;

          // Show loading indicator
          const loadingDiv = this.showLoadingOverlay('Generating Bilty PDF...');

          try {
            const bilty = this.documentGenerator.generateBilty(record);
            if (bilty) {
              const filename = this.pdfExporter.generateFilename('bilty', recordId);
              await this.pdfExporter.exportToPDF(bilty, filename);
              this.showSuccessToast('Bilty PDF downloaded successfully!');
            } else {
              throw new Error('Failed to generate bilty document');
            }
          } catch (error) {
            console.error('Failed to download bilty:', error);
            this.showErrorToast('Failed to download bilty PDF: ' + error.message);
          } finally {
            this.hideLoadingOverlay(loadingDiv);
          }
        }

        async downloadInvoice(recordId) {
          const record = this.allRecords.find(r => r.id === recordId);
          if (!record) return;

          // Show loading indicator
          const loadingDiv = this.showLoadingOverlay('Generating Invoice PDF...');

          try {
            const invoice = this.documentGenerator.generateInvoice(record);
            if (invoice) {
              const filename = this.pdfExporter.generateFilename('invoice', recordId);
              await this.pdfExporter.exportToPDF(invoice, filename);
              this.showSuccessToast('Invoice PDF downloaded successfully!');
            } else {
              throw new Error('Failed to generate invoice document');
            }
          } catch (error) {
            console.error('Failed to download invoice:', error);
            this.showErrorToast('Failed to download invoice PDF: ' + error.message);
          } finally {
            this.hideLoadingOverlay(loadingDiv);
          }
        }

        showModal(documentElement, title, recordId) {
          const modal = document.getElementById('previewModal');
          const modalContent = document.getElementById('modalContent');
          
          if (!modal || !modalContent) return;

          modalContent.innerHTML = `
            <div class="mb-4 flex justify-between items-center">
              <h4 class="text-lg font-semibold">${title} #${recordId}</h4>
              <button id="downloadFromModal" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                Download PDF
              </button>
            </div>
            <div class="border border-gray-300 rounded p-4">
              ${documentElement.outerHTML}
            </div>
          `;

          // Add download handler
          document.getElementById('downloadFromModal')?.addEventListener('click', async () => {
            const type = title.toLowerCase();
            const record = this.allRecords.find(r => r.id === recordId);
            if (record) {
              if (type === 'bilty') {
                await this.downloadBilty(recordId);
              } else {
                await this.downloadInvoice(recordId);
              }
            }
          });

          modal.classList.remove('hidden');
        }

        closeModal() {
          const modal = document.getElementById('previewModal');
          modal?.classList.add('hidden');
        }

        editRecord(recordId) {
          const record = this.allRecords.find(r => r.id === recordId);
          if (!record) return;

          // Populate edit form
          document.getElementById('editRecordId').value = record.id;
          document.getElementById('editOrigin').value = record.origin;
          document.getElementById('editDestination').value = record.destination;
          document.getElementById('editGoodsDescription').value = record.goodsDescription;
          document.getElementById('editWeight').value = record.weight;
          document.getElementById('editAmount').value = record.amount;
          document.getElementById('editDiscount').value = record.discount || 0;
          document.getElementById('editTaxes').value = record.taxes || 0;
          document.getElementById('editEwayBillNumber').value = record.ewayBillNumber || '';
          document.getElementById('editEwayBillDate').value = record.ewayBillDate || '';

          // Show edit modal
          const editModal = document.getElementById('editModal');
          editModal?.classList.remove('hidden');
        }

        closeEditModal() {
          const editModal = document.getElementById('editModal');
          editModal?.classList.add('hidden');
          
          // Clear error messages
          const errorDiv = document.getElementById('editErrorMessages');
          if (errorDiv) {
            errorDiv.classList.add('hidden');
            errorDiv.textContent = '';
          }
        }

        async handleEditSubmit(event) {
          event.preventDefault();

          const recordId = parseInt(document.getElementById('editRecordId').value);
          const userId = this.authManager.getUserId();

          const updatedData = {
            userId: userId,
            origin: document.getElementById('editOrigin').value.trim(),
            destination: document.getElementById('editDestination').value.trim(),
            goodsDescription: document.getElementById('editGoodsDescription').value.trim(),
            weight: parseFloat(document.getElementById('editWeight').value),
            amount: parseFloat(document.getElementById('editAmount').value),
            discount: parseFloat(document.getElementById('editDiscount').value) || 0,
            taxes: parseFloat(document.getElementById('editTaxes').value) || 0,
            ewayBillNumber: document.getElementById('editEwayBillNumber').value.trim() || null,
            ewayBillDate: document.getElementById('editEwayBillDate').value || null
          };

          // Basic validation
          if (!updatedData.origin || !updatedData.destination || !updatedData.goodsDescription) {
            this.showEditError('Please fill in all required fields');
            return;
          }

          if (updatedData.weight <= 0 || updatedData.amount <= 0) {
            this.showEditError('Weight and amount must be greater than 0');
            return;
          }

          // Update in database
          const result = this.dataStore.updateFreightDetails(recordId, updatedData);

          if (result.success) {
            this.showSuccessToast('Record updated successfully!');
            this.closeEditModal();
            await this.loadRecords();
          } else {
            this.showEditError('Failed to update record: ' + result.error);
          }
        }

        showEditError(message) {
          const errorDiv = document.getElementById('editErrorMessages');
          if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
          }
        }

        deleteRecord(recordId) {
          this.recordToDelete = recordId;
          
          // Show delete confirmation modal
          document.getElementById('deleteRecordId').textContent = recordId;
          const deleteModal = document.getElementById('deleteModal');
          deleteModal?.classList.remove('hidden');
        }

        closeDeleteModal() {
          const deleteModal = document.getElementById('deleteModal');
          deleteModal?.classList.add('hidden');
          this.recordToDelete = null;
        }

        async handleDeleteConfirm() {
          if (!this.recordToDelete) return;

          const userId = this.authManager.getUserId();
          const result = this.dataStore.deleteFreightDetails(this.recordToDelete, userId);

          if (result.success) {
            this.showSuccessToast('Record deleted successfully!');
            this.closeDeleteModal();
            await this.loadRecords();
          } else {
            this.showErrorToast('Failed to delete record: ' + result.error);
            this.closeDeleteModal();
          }
        }

        handleLogout() {
          this.authManager.logout();
          window.location.href = 'login.html';
        }

        // ===== SORTING METHODS =====
        handleSort(column) {
          if (this.sortColumn === column) {
            this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            this.sortColumn = column;
            this.sortDirection = 'asc';
          }

          this.sortRecords();
          this.updateSortIndicators();
          this.renderRecords();
          this.updatePaginationControls();
        }

        sortRecords() {
          this.filteredRecords.sort((a, b) => {
            let aVal = a[this.sortColumn];
            let bVal = b[this.sortColumn];

            // Handle date sorting
            if (this.sortColumn === 'createdAt') {
              aVal = new Date(aVal).getTime();
              bVal = new Date(bVal).getTime();
            }

            // Handle numeric sorting
            if (typeof aVal === 'number' && typeof bVal === 'number') {
              return this.sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            }

            // Handle string sorting
            const aStr = String(aVal).toLowerCase();
            const bStr = String(bVal).toLowerCase();
            
            if (this.sortDirection === 'asc') {
              return aStr < bStr ? -1 : aStr > bStr ? 1 : 0;
            } else {
              return aStr > bStr ? -1 : aStr < bStr ? 1 : 0;
            }
          });
        }

        updateSortIndicators() {
          document.querySelectorAll('th[data-sort]').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (th.dataset.sort === this.sortColumn) {
              th.classList.add(`sort-${this.sortDirection}`);
            }
          });
        }

        // ===== FILTER METHODS =====
        toggleFilters() {
          const panel = document.getElementById('filtersPanel');
          panel?.classList.toggle('hidden');
        }

        applyFilters() {
          this.filters = {
            dateFrom: document.getElementById('filterDateFrom')?.value || null,
            dateTo: document.getElementById('filterDateTo')?.value || null,
            amountMin: parseFloat(document.getElementById('filterAmountMin')?.value) || null,
            amountMax: parseFloat(document.getElementById('filterAmountMax')?.value) || null,
            weightMin: parseFloat(document.getElementById('filterWeightMin')?.value) || null,
            weightMax: parseFloat(document.getElementById('filterWeightMax')?.value) || null,
            origin: document.getElementById('filterOrigin')?.value.toLowerCase().trim() || '',
            destination: document.getElementById('filterDestination')?.value.toLowerCase().trim() || ''
          };

          this.applyAllFilters();
          this.currentPage = 1;
          this.sortRecords();
          this.renderRecords();
          this.updatePaginationControls();
          this.showSuccessToast('Filters applied successfully');
        }

        clearFilters() {
          document.getElementById('filterDateFrom').value = '';
          document.getElementById('filterDateTo').value = '';
          document.getElementById('filterAmountMin').value = '';
          document.getElementById('filterAmountMax').value = '';
          document.getElementById('filterWeightMin').value = '';
          document.getElementById('filterWeightMax').value = '';
          document.getElementById('filterOrigin').value = '';
          document.getElementById('filterDestination').value = '';

          this.filters = {
            dateFrom: null,
            dateTo: null,
            amountMin: null,
            amountMax: null,
            weightMin: null,
            weightMax: null,
            origin: '',
            destination: ''
          };

          this.applyAllFilters();
          this.currentPage = 1;
          this.sortRecords();
          this.renderRecords();
          this.updatePaginationControls();
          this.showSuccessToast('Filters cleared');
        }

        applyAllFilters() {
          const searchTerm = document.getElementById('searchInput')?.value.toLowerCase().trim() || '';
          
          this.filteredRecords = this.allRecords.filter(record => {
            // Search filter
            if (searchTerm) {
              const matchesSearch = 
                record.origin.toLowerCase().includes(searchTerm) ||
                record.destination.toLowerCase().includes(searchTerm) ||
                record.goodsDescription.toLowerCase().includes(searchTerm) ||
                record.id.toString().includes(searchTerm);
              
              if (!matchesSearch) return false;
            }

            // Date range filter
            if (this.filters.dateFrom) {
              const recordDate = new Date(record.createdAt).toISOString().split('T')[0];
              if (recordDate < this.filters.dateFrom) return false;
            }
            if (this.filters.dateTo) {
              const recordDate = new Date(record.createdAt).toISOString().split('T')[0];
              if (recordDate > this.filters.dateTo) return false;
            }

            // Amount range filter
            if (this.filters.amountMin !== null && record.amount < this.filters.amountMin) return false;
            if (this.filters.amountMax !== null && record.amount > this.filters.amountMax) return false;

            // Weight range filter
            if (this.filters.weightMin !== null && record.weight < this.filters.weightMin) return false;
            if (this.filters.weightMax !== null && record.weight > this.filters.weightMax) return false;

            // Origin filter
            if (this.filters.origin && !record.origin.toLowerCase().includes(this.filters.origin)) return false;

            // Destination filter
            if (this.filters.destination && !record.destination.toLowerCase().includes(this.filters.destination)) return false;

            return true;
          });
        }

        // ===== EXPORT METHODS =====
        exportToCSV() {
          if (this.filteredRecords.length === 0) {
            this.showErrorToast('No records to export');
            return;
          }

          const headers = ['ID', 'Origin', 'Destination', 'Goods Description', 'Weight (kg)', 'Amount (‚Çπ)', 'Discount (‚Çπ)', 'Taxes (‚Çπ)', 'Total (‚Çπ)', 'eWay Bill Number', 'eWay Bill Date', 'Created Date'];
          
          const rows = this.filteredRecords.map(record => {
            const total = record.amount - (record.discount || 0) + (record.taxes || 0);
            return [
              record.id,
              this.escapeCSV(record.origin),
              this.escapeCSV(record.destination),
              this.escapeCSV(record.goodsDescription),
              record.weight,
              record.amount.toFixed(2),
              (record.discount || 0).toFixed(2),
              (record.taxes || 0).toFixed(2),
              total.toFixed(2),
              this.escapeCSV(record.ewayBillNumber || ''),
              record.ewayBillDate || '',
              new Date(record.createdAt).toLocaleString('en-IN')
            ];
          });

          const csvContent = [
            headers.join(','),
            ...rows.map(row => row.join(','))
          ].join('\n');

          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          
          link.setAttribute('href', url);
          link.setAttribute('download', `freight_records_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          this.showSuccessToast(`Exported ${this.filteredRecords.length} records to CSV`);
        }

        escapeCSV(str) {
          if (str === null || str === undefined) return '';
          const s = String(str);
          if (s.includes(',') || s.includes('"') || s.includes('\n')) {
            return `"${s.replace(/"/g, '""')}"`;
          }
          return s;
        }

        async bulkPDFDownload() {
          if (this.filteredRecords.length === 0) {
            this.showErrorToast('No records to export');
            return;
          }

          const confirmed = confirm(`This will generate PDFs for ${this.filteredRecords.length} records. This may take a while. Continue?`);
          if (!confirmed) return;

          const loadingDiv = this.showLoadingOverlay(`Generating PDFs... 0/${this.filteredRecords.length}`);

          try {
            for (let i = 0; i < this.filteredRecords.length; i++) {
              const record = this.filteredRecords[i];
              
              // Update progress
              const progressText = loadingDiv.querySelector('p');
              if (progressText) {
                progressText.textContent = `Generating PDFs... ${i + 1}/${this.filteredRecords.length}`;
              }

              // Generate bilty
              const bilty = this.documentGenerator.generateBilty(record);
              if (bilty) {
                const filename = this.pdfExporter.generateFilename('bilty', record.id);
                await this.pdfExporter.exportToPDF(bilty, filename);
              }

              // Generate invoice
              const invoice = this.documentGenerator.generateInvoice(record);
              if (invoice) {
                const filename = this.pdfExporter.generateFilename('invoice', record.id);
                await this.pdfExporter.exportToPDF(invoice, filename);
              }

              // Small delay to prevent browser freezing
              await new Promise(resolve => setTimeout(resolve, 100));
            }

            this.showSuccessToast(`Successfully generated ${this.filteredRecords.length * 2} PDFs`);
          } catch (error) {
            console.error('Bulk PDF generation failed:', error);
            this.showErrorToast('Failed to generate some PDFs: ' + error.message);
          } finally {
            this.hideLoadingOverlay(loadingDiv);
          }
        }

        printList() {
          if (this.filteredRecords.length === 0) {
            this.showErrorToast('No records to print');
            return;
          }

          // Temporarily show all records (remove pagination for print)
          const originalPerPage = this.recordsPerPage;
          this.recordsPerPage = this.filteredRecords.length;
          this.renderRecords();

          // Trigger print
          window.print();

          // Restore pagination
          this.recordsPerPage = originalPerPage;
          this.renderRecords();
          this.updatePaginationControls();
        }

        showLoadingOverlay(message = 'Loading...') {
          const overlay = document.createElement('div');
          overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          overlay.id = 'loadingOverlay';
          overlay.innerHTML = `
            <div class="bg-white rounded-lg p-6 flex flex-col items-center">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
              <p class="text-gray-700 font-semibold">${message}</p>
            </div>
          `;
          document.body.appendChild(overlay);
          return overlay;
        }

        hideLoadingOverlay(overlay) {
          if (overlay && overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
        }

        showSuccessToast(message) {
          this.showToast(message, 'success');
        }

        showErrorToast(message) {
          this.showToast(message, 'error');
        }

        showToast(message, type = 'info') {
          const toast = document.createElement('div');
          const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
          toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
          toast.textContent = message;
          document.body.appendChild(toast);

          setTimeout(() => {
            toast.classList.add('animate-fade-out');
            setTimeout(() => {
              if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
              }
            }, 300);
          }, 3000);
        }

        showError(message) {
          this.showErrorToast(message);
          console.log(message);
        }

        escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
      }

      // Initialize
      const listController = new ListController();
      window.listController = listController; // Make available globally for onclick handlers
      listController.init();
    </script>
</body>
</html>

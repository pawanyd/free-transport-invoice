<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Static Site Functionality Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        h1 {
            color: #333;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .test-details {
            font-family: monospace;
            font-size: 12px;
            margin-top: 5px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>üß™ Static Site Functionality Test</h1>
    <p>This test verifies that all components required for GitHub Pages deployment are working correctly.</p>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="results"></div>

    <!-- Load required libraries -->
    <script src="assets/lib/sql-wasm.js"></script>
    <script src="assets/lib/jspdf.umd.min.js"></script>

    <script type="module">
        const resultsDiv = document.getElementById('results');
        
        function addResult(section, message, type = 'info', details = '') {
            const sectionDiv = document.getElementById(section) || createSection(section);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `
                <strong>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'} ${message}</strong>
                ${details ? `<div class="test-details">${details}</div>` : ''}
            `;
            sectionDiv.appendChild(resultDiv);
        }
        
        function createSection(id) {
            const section = document.createElement('div');
            section.id = id;
            section.className = 'test-section';
            section.innerHTML = `<h2>${id.replace(/-/g, ' ').toUpperCase()}</h2>`;
            resultsDiv.appendChild(section);
            return section;
        }
        
        window.clearResults = function() {
            resultsDiv.innerHTML = '';
        };
        
        window.runAllTests = async function() {
            clearResults();
            
            // Test 1: SQLite WASM Loading
            await testSQLiteWASM();
            
            // Test 2: jsPDF Loading
            await testJsPDF();
            
            // Test 3: Module Loading
            await testModuleLoading();
            
            // Test 4: LocalStorage
            await testLocalStorage();
            
            // Test 5: Asset Loading
            await testAssetLoading();
            
            // Test 6: Browser Compatibility
            await testBrowserCompatibility();
            
            addResult('summary', 'All tests completed! Check results above.', 'info');
        };
        
        async function testSQLiteWASM() {
            const section = 'sqlite-wasm-test';
            
            try {
                // Check if initSqlJs is available
                if (typeof initSqlJs === 'undefined') {
                    addResult(section, 'initSqlJs is not defined', 'error', 'sql-wasm.js may not have loaded correctly');
                    return;
                }
                
                addResult(section, 'initSqlJs function is available', 'success');
                
                // Try to initialize SQLite
                const SQL = await initSqlJs({
                    locateFile: file => `assets/lib/${file}`
                });
                
                addResult(section, 'SQLite WASM initialized successfully', 'success');
                
                // Create a test database
                const db = new SQL.Database();
                db.run('CREATE TABLE test (id INTEGER PRIMARY KEY, name TEXT)');
                db.run('INSERT INTO test (name) VALUES (?)', ['Test Entry']);
                
                const result = db.exec('SELECT * FROM test');
                
                if (result.length > 0 && result[0].values.length > 0) {
                    addResult(section, 'SQLite database operations working', 'success', 
                        `Created table, inserted data, and queried successfully`);
                } else {
                    addResult(section, 'SQLite query returned no results', 'warning');
                }
                
                db.close();
                
            } catch (error) {
                addResult(section, 'SQLite WASM test failed', 'error', error.message);
                console.error('SQLite test error:', error);
            }
        }
        
        async function testJsPDF() {
            const section = 'jspdf-test';
            
            try {
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined') {
                    addResult(section, 'jsPDF is not available', 'error', 'window.jspdf is undefined');
                    return;
                }
                
                addResult(section, 'jsPDF library is available', 'success', 'window.jspdf exists');
                
                // Try to create a PDF instance
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                addResult(section, 'jsPDF instance created successfully', 'success');
                
                // Test basic PDF operations
                doc.text('Test PDF', 10, 10);
                const pdfOutput = doc.output('datauristring');
                
                if (pdfOutput && pdfOutput.startsWith('data:application/pdf')) {
                    addResult(section, 'PDF generation working correctly', 'success', 
                        'Generated PDF data URI successfully');
                } else {
                    addResult(section, 'PDF generation may have issues', 'warning');
                }
                
            } catch (error) {
                addResult(section, 'jsPDF test failed', 'error', error.message);
                console.error('jsPDF test error:', error);
            }
        }
        
        async function testModuleLoading() {
            const section = 'module-loading-test';
            
            const modules = [
                { name: 'config.js', path: './assets/js/config.js' },
                { name: 'datastore.js', path: './assets/js/datastore.js' },
                { name: 'auth.js', path: './assets/js/auth.js' },
                { name: 'validator.js', path: './assets/js/validator.js' },
                { name: 'generator.js', path: './assets/js/generator.js' },
                { name: 'pdf-exporter.js', path: './assets/js/pdf-exporter.js' },
                { name: 'ui-controller.js', path: './assets/js/ui-controller.js' }
            ];
            
            for (const module of modules) {
                try {
                    const imported = await import(module.path);
                    
                    if (imported && Object.keys(imported).length > 0) {
                        addResult(section, `${module.name} loaded successfully`, 'success', 
                            `Exports: ${Object.keys(imported).join(', ')}`);
                    } else {
                        addResult(section, `${module.name} loaded but has no exports`, 'warning');
                    }
                } catch (error) {
                    addResult(section, `Failed to load ${module.name}`, 'error', error.message);
                    console.error(`Module loading error (${module.name}):`, error);
                }
            }
        }
        
        async function testLocalStorage() {
            const section = 'localstorage-test';
            
            try {
                // Check if localStorage is available
                if (typeof localStorage === 'undefined') {
                    addResult(section, 'localStorage is not available', 'error');
                    return;
                }
                
                addResult(section, 'localStorage is available', 'success');
                
                // Test write
                const testKey = 'test_key_' + Date.now();
                const testValue = 'test_value_' + Math.random();
                localStorage.setItem(testKey, testValue);
                
                // Test read
                const retrieved = localStorage.getItem(testKey);
                
                if (retrieved === testValue) {
                    addResult(section, 'localStorage read/write working', 'success');
                } else {
                    addResult(section, 'localStorage read/write mismatch', 'error', 
                        `Expected: ${testValue}, Got: ${retrieved}`);
                }
                
                // Test delete
                localStorage.removeItem(testKey);
                const afterDelete = localStorage.getItem(testKey);
                
                if (afterDelete === null) {
                    addResult(section, 'localStorage delete working', 'success');
                } else {
                    addResult(section, 'localStorage delete failed', 'warning');
                }
                
            } catch (error) {
                addResult(section, 'localStorage test failed', 'error', error.message);
                console.error('localStorage test error:', error);
            }
        }
        
        async function testAssetLoading() {
            const section = 'asset-loading-test';
            
            const assets = [
                { name: 'styles.css', path: 'assets/css/styles.css', type: 'text/css' },
                { name: 'logo.svg', path: 'assets/images/logo.svg', type: 'image/svg+xml' },
                { name: 'signature.svg', path: 'assets/images/signature.svg', type: 'image/svg+xml' },
                { name: 'seal.svg', path: 'assets/images/seal.svg', type: 'image/svg+xml' }
            ];
            
            for (const asset of assets) {
                try {
                    const response = await fetch(asset.path);
                    
                    if (response.ok) {
                        addResult(section, `${asset.name} loaded successfully`, 'success', 
                            `Status: ${response.status}, Type: ${response.headers.get('content-type') || 'unknown'}`);
                    } else {
                        addResult(section, `${asset.name} failed to load`, 'error', 
                            `Status: ${response.status}`);
                    }
                } catch (error) {
                    addResult(section, `Error loading ${asset.name}`, 'error', error.message);
                }
            }
        }
        
        async function testBrowserCompatibility() {
            const section = 'browser-compatibility-test';
            
            // Check browser features
            const features = [
                { name: 'ES6 Modules', check: () => 'noModule' in document.createElement('script') },
                { name: 'Fetch API', check: () => typeof fetch !== 'undefined' },
                { name: 'Promises', check: () => typeof Promise !== 'undefined' },
                { name: 'Async/Await', check: () => {
                    try {
                        eval('(async () => {})');
                        return true;
                    } catch (e) {
                        return false;
                    }
                }},
                { name: 'Web Crypto API', check: () => typeof crypto !== 'undefined' && typeof crypto.subtle !== 'undefined' },
                { name: 'LocalStorage', check: () => typeof localStorage !== 'undefined' },
                { name: 'SessionStorage', check: () => typeof sessionStorage !== 'undefined' }
            ];
            
            addResult(section, `Browser: ${navigator.userAgent}`, 'info');
            
            for (const feature of features) {
                try {
                    const supported = feature.check();
                    if (supported) {
                        addResult(section, `${feature.name} supported`, 'success');
                    } else {
                        addResult(section, `${feature.name} NOT supported`, 'error');
                    }
                } catch (error) {
                    addResult(section, `${feature.name} check failed`, 'error', error.message);
                }
            }
        }
        
        // Auto-run tests on page load
        console.log('Static functionality test page loaded. Click "Run All Tests" to begin.');
    </script>
</body>
</html>
